<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Continuidad Pro BIA - Gesti贸n de Emergencias</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <header>
        <h1> Sistema de Continuidad del Negocio</h1>
        <div style="display:flex; align-items:center; gap:15px">
            <span id="displayUserName"></span>
            <button type="button" id="btnLogout" class="btn-danger-small" style="background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Cerrar Sesi贸n</button>
        </div>
    </header>

    <div class="main-wrapper">
        <aside id="panel-controles">
            <label> Nivel de Alerta</label>
            <select id="nivelAlerta">
                <option value="Cr铆tica (Roja)"> Cr铆tica (Roja)</option>
                <option value="Alta (Naranja)"> Alta (Naranja)</option>
                <option value="Media (Amarilla)"> Media (Amarilla)</option>
                <option value="Informativa (Azul)"> Informativa (Azul)</option>
            </select>

            <label> Tipo de Evento</label>
            <select id="tipoEvento">
                <option value="Desastre natural">Desastre natural</option>
                <option value="Incendio">Incendio</option>
                <option value="Fallo servicios p煤blicos">Fallo de servicios p煤blicos</option>
                <option value="Emergencia de seguridad">Emergencia de seguridad</option>
            </select>
            
            <label> Descripci贸n Detallada</label>
            <textarea id="descripcionEvento" placeholder="Describe el evento aqu铆..."></textarea>

            <!-- BARRA DE BSQUEDA RESTAURADA -->
            <label> Buscar Direcci贸n / Ubicaci贸n</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="direccionBuscar" placeholder="Ej: Calle 100, Bogot谩">
                <button type="button" id="btnBuscarDireccion" class="btn-secondary" style="width: 60px; margin-top: 5px;"></button>
            </div>

            <hr class="separador">
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
                <button type="button" id="btnVerDashboard" class="btn-info"> Dashboard</button>
                <button type="button" id="btnVerHistorial" class="btn-info"> Historial</button>
            </div>
            
            <!-- Bot贸n Admin (Solo se ve si es admin) -->
            <button type="button" id="btnAdmin" class="btn-primary" style="display:none; background:#475569">锔 Administraci贸n</button>

            <button type="button" id="btnGenerarResumen" class="btn-primary"> GENERAR IMPACTO</button>
            <button type="button" id="btnDescargarPDF" class="btn-success"> DESCARGAR INFORME</button>
        </aside>

        <main id="map"></main>
    </div>

    <div id="panel-resultados">
        <div id="infoResumen"></div>
        <div class="stats-container"></div>
        <div class="grafica-container"><canvas id="graficaSedes"></canvas></div>
        <div id="listaSedesAfectadas"></div>
    </div>

    <!-- MODALES (Dashboard, Historial, Admin) -->
    <div id="modalAdmin" class="modal"><div class="modal-content">
        <div class="modal-header">
            <div style="display:flex; gap:10px">
                <h2>锔 Gesti贸n</h2>
                <button type="button" class="btn-tab" onclick="switchTab('tab-users')">Usuarios</button>
                <button type="button" class="btn-tab" onclick="switchTab('tab-sedes')">Sedes/BIA</button>
            </div>
            <span class="btn-close" id="cerrarAdmin">&times;</span>
        </div>
        <div class="modal-body">
            <div id="tab-users" class="admin-tab">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px">
                    <div><h3>Listado</h3><div id="listaUsuariosAdmin"></div></div>
                    <div><h3>Gestionar</h3>
                        <input type="hidden" id="adm_user_id">
                        <input type="text" id="adm_user_full" placeholder="Nombre">
                        <input type="text" id="adm_user_name" placeholder="Usuario">
                        <input type="password" id="adm_user_pass" placeholder="Clave">
                        <select id="adm_user_role"><option value="analista">Analista</option><option value="admin">Admin</option></select>
                        <button type="button" class="btn-primary" onclick="guardarUsuario()">Guardar</button>
                    </div>
                </div>
            </div>
            <div id="tab-sedes" class="admin-tab" style="display:none">
                <div style="display:grid; grid-template-columns:1fr 1.2fr; gap:20px">
                    <div><h3>Sedes</h3><div id="listaSedesAdmin"></div><hr>
                        <input type="hidden" id="adm_sede_id">
                        <input type="text" id="adm_sede_nom" placeholder="Nombre">
                        <input type="text" id="adm_sede_dir" placeholder="Direcci贸n">
                        <div style="display:flex; gap:5px"><input type="number" step="any" id="adm_sede_lat" placeholder="Lat"><input type="number" step="any" id="adm_sede_lng" placeholder="Lng"><button type="button" class="btn-info" style="width:auto" onclick="iniciarCapturaMapa()"></button></div>
                        <button type="button" class="btn-success" onclick="guardarSede()">Guardar Sede</button>
                    </div>
                    <div><h3>Procesos BIA</h3><select id="sel_sede_proceso" onchange="cargarProcesosSede()"></select><div id="listaProcesosAdmin"></div><hr>
                        <input type="text" id="proc_nombre" placeholder="Proceso"><select id="proc_crit"><option value="Alta">Alta</option><option value="Media">Media</option><option value="Baja">Baja</option></select>
                        <div style="display:flex; gap:5px"><input type="number" id="proc_rto" placeholder="RTO (h)"><input type="number" id="proc_rpo" placeholder="RPO (h)"></div>
                        <button type="button" class="btn-primary" onclick="guardarProceso()">A帽adir Proceso</button>
                    </div>
                </div>
            </div>
        </div>
    </div></div>

<!-- MODAL DASHBOARD ACTUALIZADO -->
    <div id="modalDashboard" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2> An谩lisis de Vulnerabilidad Hist贸rica</h2>
                <div style="display:flex; gap:10px">
                    <button type="button" id="btnExportarExcel" class="btn-success" style="width:auto; margin:0"> Excel</button>
                    <span class="btn-close" id="cerrarDashboard">&times;</span>
                </div>
            </div>
            <div class="modal-body">
                <div class="dashboard-canvas-wrapper">
                    <canvas id="graficaVulnerabilidad"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div id="modalHistorial" class="modal"><div class="modal-content"><div class="modal-header"><h2> Historial</h2><span class="btn-close" id="cerrarHistorial">&times;</span></div><div class="modal-body" id="listaHistorialItems"></div></div></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="js/map.js"></script>
</body>
</html>