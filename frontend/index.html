<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Sistema de Continuidad Pro BIA</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>
    <header>
        <h1>üè• Sistema de Continuidad del Negocio</h1>
        <div style="display:flex; align-items:center; gap:20px">
            <span id="displayUserName"></span>
            <button type="button" id="btnLogout" class="btn-danger-small"
                style="background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; width:auto; margin:0">Cerrar
                Sesi√≥n</button>
        </div>
    </header>

    <div class="main-wrapper">
        <aside id="panel-controles">
            <label>üö® NIVEL DE ALERTA</label>
            <select id="nivelAlerta">
                <option value="Cr√≠tica (Roja)">üî¥ Cr√≠tica (Roja)</option>
                <option value="Alta (Naranja)">üü† Alta (Naranja)</option>
                <option value="Media (Amarilla)">üü° Media (Amarilla)</option>
                <option value="Informativa (Azul)">üîµ Informativa (Azul)</option>
            </select>

            <label>üìç TIPO DE EVENTO</label>
            <select id="tipoEvento">
                <option value="Desastre natural">Desastre natural</option>
                <option value="Incendio">Incendio</option>
                <option value="Fallo servicios p√∫blicos">Fallo servicios p√∫blicos</option>
            </select>

            <label>üìù DESCRIPCI√ìN DETALLADA</label>
            <textarea id="descripcionEvento" placeholder="Describe el impacto..."></textarea>

            <label>üîç BUSCAR DIRECCI√ìN / UBICACI√ìN</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="direccionBuscar" placeholder="Ej: Calle 100, Bogot√°">
                <button type="button" id="btnBuscarDireccion" class="btn-secondary"
                    style="width: 50px; margin-top: 5px;"><i class="fas fa-search"></i></button>
            </div>

            <div class="card-analitica"
                style="background: #f0f7ff; border: 1px solid #dbeafe; padding: 15px; border-radius: 12px; margin: 15px 0;">
                <label style="margin-top:0"><i class="fas fa-filter"></i> FILTRO DE SEDE O PROCESO</label>
                <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                    <input type="text" id="buscadorProcesos" placeholder="Buscar palabra clave..."
                        style="background:white; margin:0">
                    <button type="button" id="btnProcesosSearch" class="btn-info" style="width: 50px; margin:0"><i
                            class="fas fa-search"></i></button>
                </div>

                <label>‚è±Ô∏è RTO M√ÅXIMO</label>
                <select id="filtroRTO" onchange="ejecutarFiltroAvanzado()">
                    <option value="999">Ver todos</option>
                    <option value="4">Sedes Cr√≠ticas (RTO ‚â§ 4h)</option>
                    <option value="12">Sedes Esenciales (RTO ‚â§ 12h)</option>
                </select>
                <button type="button" class="btn-info" style="font-size:11px; padding:8px; margin-top:10px"
                    onclick="resetearFiltros()">üåê Ver Todas las Sedes</button>
            </div>

            <button type="button" id="btnConsultarBIA" class="btn-secondary">üîç Visor T√©cnico (BIA)</button>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:10px">
                <button type="button" id="btnVerDashboard" class="btn-info">üìà Dashboard</button>
                <button type="button" id="btnVerHistorial" class="btn-info">üìã Historial</button>
            </div>

            <button type="button" id="btnAdmin" class="btn-primary" style="display:none; background:#475569">‚öôÔ∏è
                Administraci√≥n</button>
            <button type="button" id="btnGenerarResumen" class="btn-primary">üìä GENERAR IMPACTO</button>
            <button type="button" id="btnDescargarPDF" class="btn-success">üì• DESCARGAR INFORME</button>
        </aside>

        <main id="map"></main>
    </div>

    <div id="panel-resultados">
        <div id="infoResumen"></div>
        <div class="stats-container"></div>
        <div class="grafica-container"
            style="display:flex; flex-direction:column; gap:30px; margin-top:20px; max-width:100%; height:auto;">
            <div style="width:100%; height:300px; display:block;">
                <h4 style="text-align:center; margin-bottom:10px;">Nivel Local (Ciudad)</h4>
                <div style="position:relative; height:250px; width:100%"><canvas id="graficaSedes"></canvas></div>
            </div>
            <div style="width:100%; height:300px; display:block;">
                <h4 style="text-align:center; margin-bottom:10px;">Nivel Nacional</h4>
                <div style="position:relative; height:250px; width:100%"><canvas id="graficaNacional"></canvas></div>
            </div>
        </div>
        <div id="listaSedesAfectadas"></div>
    </div>

    <!-- MODALES -->
    <div id="modalBIA" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîç Visor BIA</h2><span class="btn-close" id="cerrarBIA">&times;</span>
            </div>
            <div class="modal-body" id="tablaBIACompleta"></div>
        </div>
    </div>
    <div id="modalDashboard" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìà Dashboard</h2><span class="btn-close" id="cerrarDashboard">&times;</span>
            </div>
            <div class="modal-body" style="height:500px"><canvas id="graficaVulnerabilidad"></canvas></div>
        </div>
    </div>
    <div id="modalHistorial" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìú Historial</h2><button type="button" id="btnExportarHistorial" class="btn-success"
                    style="width:auto">CSV</button><span class="btn-close" id="cerrarHistorial">&times;</span>
            </div>
            <div class="modal-body" id="listaHistorialItems"></div>
        </div>
    </div>

    <div id="modalAdmin" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div style="display:flex; gap:10px">
                    <h2>‚öôÔ∏è Gesti√≥n</h2><button type="button" class="btn-tab"
                        onclick="switchTab('tab-users')">Usuarios</button><button type="button" class="btn-tab"
                        onclick="switchTab('tab-sedes')">Sedes/BIA</button>
                </div>
                <span class="btn-close" id="cerrarAdmin">&times;</span>
            </div>
            <div class="modal-body" id="adminBody">
                <div id="tab-users" class="admin-tab">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px">
                        <div>
                            <h3>Listado</h3>
                            <div id="listaUsuariosAdmin"></div>
                        </div>
                        <div>
                            <h3>Gestionar</h3><input type="hidden" id="adm_user_id"><input type="text"
                                id="adm_user_full" placeholder="Nombre"><input type="text" id="adm_user_name"
                                placeholder="Usuario"><input type="password" id="adm_user_pass"
                                placeholder="Clave"><select id="adm_user_role">
                                <option value="analista">Analista</option>
                                <option value="admin">Admin</option>
                            </select><button type="button" class="btn-primary"
                                onclick="guardarUsuario()">Guardar</button>
                        </div>
                    </div>
                </div>
                <div id="tab-sedes" class="admin-tab" style="display:none">
                    <div style="display:grid; grid-template-columns:1fr 1.2fr; gap:20px">
                        <div>
                            <h3>Sedes</h3>
                            <div id="listaSedesAdmin"></div>
                            <hr><input type="hidden" id="adm_sede_id"><input type="text" id="adm_sede_nom"
                                placeholder="Nombre"><input type="text" id="adm_sede_dir" placeholder="Direcci√≥n">
                            <div style="display:flex; gap:5px"><input type="number" step="any" id="adm_sede_lat"
                                    placeholder="Lat"><input type="number" step="any" id="adm_sede_lng"
                                    placeholder="Lng"><button type="button" class="btn-info" style="width:auto"
                                    onclick="iniciarCapturaMapa()">üìç</button></div><button type="button"
                                class="btn-success" onclick="guardarSede()">Guardar Sede</button>
                        </div>
                        <div>
                            <h3>Procesos BIA</h3><select id="sel_sede_proceso" onchange="cargarProcesosSede()"></select>
                            <div id="listaProcesosAdmin"></div>
                            <hr><input type="text" id="proc_nombre" placeholder="Proceso"><select id="proc_crit">
                                <option value="Alta">Alta</option>
                                <option value="Media">Media</option>
                                <option value="Baja">Baja</option>
                            </select>
                            <div style="display:flex; gap:5px"><input type="number" id="proc_rto" value="4"><input
                                    type="number" id="proc_rpo" value="2"></div><button type="button"
                                class="btn-primary" onclick="guardarProceso()">A√±adir Proceso</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="js/map.js"></script>
</body>

</html>